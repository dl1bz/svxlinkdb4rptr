function PCMPlayer(t){this.init(t)}function iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function SVXPlayer(t,i){this.ws=null,this.socketURL="ws://"+document.location.hostname+":"+t,this.sampleRate=iOS()?32e3:48e3,this.player=new PCMPlayer({encoding:"16bitInt",channels:1,sampleRate:this.sampleRate,flushingTime:2e3}),this.btn=i,this.btnDefault=i.style.backgroundColor,this.stop(),window.addEventListener("unload",function(t){this.destroy()})}function playAudioToggle(t,i){void 0===window.svxp&&(window.svxp=new SVXPlayer(t,i)),svxp.isPlaying()?window.svxp.stop():window.svxp.play()}PCMPlayer.prototype.init=function(t){this.option=Object.assign({},{encoding:"16bitInt",channels:1,sampleRate:48e3,flushingTime:1e3},t),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()},PCMPlayer.prototype.getMaxValue=function(){var t={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},PCMPlayer.prototype.getTypedArray=function(){var t={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},PCMPlayer.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},PCMPlayer.prototype.isTypedArray=function(t){return t.byteLength&&t.buffer&&t.buffer.constructor==ArrayBuffer},PCMPlayer.prototype.feed=function(t){var i;this.isTypedArray(t)&&(t=this.getFormatedValue(t),(i=new Float32Array(this.samples.length+t.length)).set(this.samples,0),i.set(t,this.samples.length),this.samples=i)},PCMPlayer.prototype.getFormatedValue=function(t){for(var t=new this.typedArray(t.buffer),i=new Float32Array(t.length),e=0;e<t.length;e++)i[e]=t[e]/this.maxValue;return i},PCMPlayer.prototype.volume=function(t){this.gainNode.gain.value=t},PCMPlayer.prototype.stop=function(){this.interval&&clearInterval(this.interval),this.samples=null},PCMPlayer.prototype.play=function(){this.samples=new Float32Array,this.interval=setInterval(this.flush,this.option.flushingTime)},PCMPlayer.prototype.destroy=function(){this.stop(),this.audioCtx.close(),this.audioCtx=null},PCMPlayer.prototype.flush=function(){if(this.samples.length){for(var t,i,e,n,s=this.audioCtx.createBufferSource(),o=this.samples.length/this.option.channels,a=this.audioCtx.createBuffer(this.option.channels,o,this.option.sampleRate),r=0;r<this.option.channels;r++)for(t=a.getChannelData(r),i=r,n=50,e=0;e<o;e++)t[e]=this.samples[i],e<50&&(t[e]=t[e]*e/50),o-51<=e&&(t[e]=t[e]*n--/50),i+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),console.log("start vs current "+this.startTime+" vs "+this.audioCtx.currentTime+" duration: "+a.duration),s.buffer=a,s.connect(this.gainNode),s.start(this.startTime),this.startTime+=a.duration,this.samples=new Float32Array}},SVXPlayer.prototype.destroy=function(){this.stop(),this.player.destroy()},SVXPlayer.prototype.play=function(){var r=this;this.btn.style.backgroundColor="#008000",this.ws=new WebSocket(this.socketURL),this.ws.binaryType="arraybuffer",this.ws.closing=!1,this.ws.addEventListener("message",function(t){var e=new Uint8Array(t.data);if(48e3==this.sampleRate)r.player.feed(e);else{var n=r.player.option.sampleRate/48e3,o=new Uint8Array(e.length*n),a=0;for(i=0;i<e.length;i+=2)for(s=0;s<n;s++)o[a++]=e[i],o[a++]=e[i+1];r.player.feed(o)}}),this.player.play(),this.ws.onclose=function(){this.closing||(r.ws=null,r.btn.style.backgroundColor="#ff0000",setTimeout(function(){r.play(r.btn)},5e3))}},SVXPlayer.prototype.stop=function(){this.player.stop(),this.isPlaying()&&(this.ws.closing=!0,this.ws.close(),this.ws=null),this.btn.style.backgroundColor=this.btnDefault},SVXPlayer.prototype.isPlaying=function(){return null!=this.ws};